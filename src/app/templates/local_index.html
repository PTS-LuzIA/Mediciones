{% extends "base.html" %}

{% block title %}Inicio - MVP Mediciones{% endblock %}

{% block content %}
<div class="card">
    <h2>Subir Presupuesto PDF</h2>
    <p style="margin: 20px 0; color: #6c757d;">
        Arrastra un archivo PDF de presupuesto de construcci√≥n o haz clic para seleccionar
    </p>

    <form id="uploadForm" enctype="multipart/form-data" method="post" action="/upload">
        <div class="upload-zone" id="uploadZone">
            <input type="file" id="fileInput" name="file" accept=".pdf" style="display: none;">
            <div id="uploadContent">
                <h3 style="color: #667eea; margin-bottom: 10px;">üìÑ Seleccionar PDF</h3>
                <p style="color: #6c757d;">Formatos soportados: PDF con mediciones de obra</p>
                <p style="color: #6c757d; font-size: 0.9em; margin-top: 10px;">
                    Click aqu√≠ o arrastra el archivo
                </p>
            </div>
            <div id="fileInfo" style="display: none;">
                <h3 style="color: #28a745; margin-bottom: 10px;">‚úì Archivo seleccionado</h3>
                <p id="fileName" style="color: #333; font-weight: 600;"></p>
                <p id="fileSize" style="color: #6c757d; font-size: 0.9em;"></p>
                <button type="submit" class="btn btn-success" style="margin-top: 20px;">
                    Procesar PDF
                </button>
            </div>
        </div>
    </form>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Procesando PDF...</p>
        <p style="color: #6c757d; font-size: 0.9em; margin-top: 10px;">
            Esto puede tardar unos segundos dependiendo del tama√±o del documento
        </p>
    </div>
</div>

<div class="card">
    <h2>Caracter√≠sticas</h2>
    <div class="stats">
        <div class="stat-card">
            <h3>üìÑ</h3>
            <p>Extracci√≥n de PDFs</p>
        </div>
        <div class="stat-card">
            <h3>üóÇÔ∏è</h3>
            <p>Estructura Jer√°rquica</p>
        </div>
        <div class="stat-card">
            <h3>üíæ</h3>
            <p>Base de Datos SQLite</p>
        </div>
        <div class="stat-card">
            <h3>üìä</h3>
            <p>M√∫ltiples Exportaciones</p>
        </div>
    </div>
</div>

<div class="card">
    <h2>C√≥mo funciona</h2>
    <ol style="line-height: 2; color: #495057;">
        <li><strong>Sube tu PDF:</strong> Selecciona un archivo de presupuesto de construcci√≥n</li>
        <li><strong>Procesamiento autom√°tico:</strong> Extrae cap√≠tulos, subcap√≠tulos, apartados y partidas</li>
        <li><strong>Visualiza resultados:</strong> Navega por la estructura del presupuesto</li>
        <li><strong>Exporta:</strong> Descarga en formato CSV, Excel, XML o BC3/FIEBDC-3</li>
    </ol>
</div>
{% endblock %}

{% block scripts %}
<script>
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadContent = document.getElementById('uploadContent');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadForm = document.getElementById('uploadForm');
    const loading = document.getElementById('loading');

    // Click para abrir selector
    uploadZone.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') {
            fileInput.click();
        }
    });

    // Drag & Drop
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === 'application/pdf') {
            fileInput.files = files;
            showFileInfo(files[0]);
        }
    });

    // Cuando se selecciona archivo
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            showFileInfo(e.target.files[0]);
        }
    });

    function showFileInfo(file) {
        fileName.textContent = file.name;
        fileSize.textContent = formatBytes(file.size);
        uploadContent.style.display = 'none';
        fileInfo.style.display = 'block';
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Submit form
    uploadForm.addEventListener('submit', (e) => {
        e.preventDefault();

        if (fileInput.files.length === 0) {
            alert('Por favor, selecciona un archivo PDF');
            return;
        }

        // Mostrar loading
        uploadZone.style.display = 'none';
        loading.classList.add('active');

        // Submit
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            } else if (!response.ok) {
                throw new Error('Error al procesar PDF');
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
            loading.classList.remove('active');
            uploadZone.style.display = 'block';
        });
    });
</script>
{% endblock %}
