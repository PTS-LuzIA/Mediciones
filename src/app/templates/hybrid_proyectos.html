{% extends "base.html" %}

{% block title %}Proyectos H√≠bridos - MVP Mediciones{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>‚ö° Proyectos H√≠bridos (IA + Local + Validaci√≥n)</h2>
        <a href="/hybrid-upload" class="btn btn-success">+ Subir Nuevo PDF H√≠brido</a>
    </div>

    {% if proyectos %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Fase</th>
                <th>Coincidencia %</th>
                <th>Validados</th>
                <th>Discrepancias</th>
                <th>Partidas</th>
                <th>Fecha</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for proyecto in proyectos %}
            <tr>
                <td><span class="badge badge-info">#{{ proyecto.id }}</span></td>
                <td>
                    <a href="/hybrid-proyecto/{{ proyecto.id }}" style="color: #667eea; text-decoration: none; font-weight: 600;">
                        {{ proyecto.nombre or 'Sin nombre' }}
                    </a>
                </td>
                <td>
                    {% if proyecto.fase == 'COMPLETADO' %}
                    <span class="badge badge-success">‚úì COMPLETADO</span>
                    {% elif proyecto.fase == 'FASE3_VALIDACION' %}
                    <span class="badge" style="background: #28a745; color: white;">FASE 3</span>
                    {% elif proyecto.fase == 'FASE2_PARTIDAS' %}
                    <span class="badge" style="background: #ffc107; color: #000;">FASE 2</span>
                    {% elif proyecto.fase == 'FASE1_ESTRUCTURA' %}
                    <span class="badge" style="background: #17a2b8; color: white;">FASE 1</span>
                    {% else %}
                    <span class="badge" style="background: #6c757d; color: white;">CREADO</span>
                    {% endif %}
                </td>
                <td>
                    {% if proyecto.estadisticas and proyecto.estadisticas.porcentaje_coincidencia is not none %}
                        {% set coincidencia = proyecto.estadisticas.porcentaje_coincidencia %}
                        <span class="badge {% if coincidencia >= 95 %}badge-success{% elif coincidencia >= 85 %}{% else %}badge-danger{% endif %}" style="{% if coincidencia < 95 and coincidencia >= 85 %}background: #ffc107; color: #000;{% elif coincidencia < 85 %}background: #dc3545; color: white;{% endif %}">
                            {{ coincidencia|round(1) }}%
                        </span>
                    {% else %}
                    <span style="color: #6c757d;">-</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% if proyecto.estadisticas %}
                    <span class="badge badge-success">{{ proyecto.estadisticas.validados }}</span>
                    {% else %}
                    <span style="color: #6c757d;">-</span>
                    {% endif %}
                </td>
                <td style="text-align: center;">
                    {% if proyecto.estadisticas and proyecto.estadisticas.discrepancias > 0 %}
                    <span class="badge" style="background: #ffc107; color: #000;">{{ proyecto.estadisticas.discrepancias }}</span>
                    {% elif proyecto.estadisticas %}
                    <span style="color: #6c757d;">0</span>
                    {% else %}
                    <span style="color: #6c757d;">-</span>
                    {% endif %}
                </td>
                <td style="text-align: center;"><strong>{{ proyecto.num_partidas or 0 }}</strong></td>
                <td>{{ proyecto.fecha_creacion[:10] if proyecto.fecha_creacion else '-' }}</td>
                <td>
                    <div style="display: flex; gap: 8px;">
                        <a href="/hybrid-proyecto/{{ proyecto.id }}" class="btn" style="padding: 6px 12px; font-size: 0.9em;">
                            Ver Detalle
                        </a>
                        <button onclick="eliminarProyectoHibrido({{ proyecto.id }})"
                                class="btn"
                                style="padding: 6px 12px; font-size: 0.9em; background: #dc3545; color: white;"
                                title="Eliminar proyecto">
                            üóëÔ∏è
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
        <h3 style="margin-bottom: 20px;">No hay proyectos h√≠bridos</h3>
        <p style="margin-bottom: 30px;">Sube tu primer PDF para procesarlo con el sistema h√≠brido (IA + Local + Validaci√≥n)</p>
        <a href="/hybrid-upload" class="btn btn-success">Subir PDF</a>
    </div>
    {% endif %}
</div>

{% if proyectos %}
<div class="card">
    <h3>Estad√≠sticas Generales - Sistema H√≠brido</h3>
    <div class="stats">
        <div class="stat-card">
            <h3>{{ proyectos|length }}</h3>
            <p>Proyectos Totales</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
            {% set total_validados = proyectos|sum(attribute='estadisticas.validados') if proyectos[0].estadisticas else 0 %}
            <h3>{{ total_validados }}</h3>
            <p>Elementos Validados</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
            {% set total_discrepancias = proyectos|sum(attribute='estadisticas.discrepancias') if proyectos[0].estadisticas else 0 %}
            <h3>{{ total_discrepancias }}</h3>
            <p>Discrepancias Detectadas</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
            {% set proyectos_completados = proyectos|selectattr('fase', 'equalto', 'COMPLETADO')|list|length %}
            <h3>{{ proyectos_completados }}</h3>
            <p>Proyectos Completados</p>
        </div>
    </div>
</div>

<div class="card">
    <h3>üìä Leyenda de Estados</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
        <div style="padding: 15px; background: #d4edda; border-left: 4px solid #28a745; border-radius: 5px;">
            <strong style="color: #155724;">‚úì VALIDADO</strong>
            <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #155724;">Totales IA y Local coinciden (¬±5%)</p>
        </div>
        <div style="padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px;">
            <strong style="color: #856404;">‚ö†Ô∏è DISCREPANCIA</strong>
            <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #856404;">Diferencia > 5%, requiere revisi√≥n</p>
        </div>
        <div style="padding: 15px; background: #d1ecf1; border-left: 4px solid #17a2b8; border-radius: 5px;">
            <strong style="color: #0c5460;">üìã REVISADO IA</strong>
            <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #0c5460;">Corregido por agente de IA</p>
        </div>
        <div style="padding: 15px; background: #f8d7da; border-left: 4px solid #dc3545; border-radius: 5px;">
            <strong style="color: #721c24;">‚ùå ERROR</strong>
            <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #721c24;">Error en procesamiento</p>
        </div>
    </div>
</div>

<div class="card">
    <h3>üéØ Fases del Procesamiento H√≠brido</h3>
    <div style="margin-top: 15px;">
        <div style="display: flex; gap: 20px; margin-bottom: 15px;">
            <div style="flex: 1; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0;">1Ô∏è‚É£ FASE 1</h4>
                <strong>Extracci√≥n de Estructura (IA)</strong>
                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em;">
                    StructureExtractionAgent extrae cap√≠tulos, subcap√≠tulos y totales
                </p>
            </div>
            <div style="flex: 1; padding: 15px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0;">2Ô∏è‚É£ FASE 2</h4>
                <strong>Extracci√≥n de Partidas (Local)</strong>
                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em;">
                    PartidaParser extrae partidas individuales con parser tradicional
                </p>
            </div>
            <div style="flex: 1; padding: 15px; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; border-radius: 8px;">
                <h4 style="margin: 0 0 10px 0;">3Ô∏è‚É£ FASE 3</h4>
                <strong>Validaci√≥n Cruzada</strong>
                <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 0.9em;">
                    Compara totales ‚Ç¨ IA vs Local (igualdad exacta, solo valor total)
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
async function eliminarProyectoHibrido(proyectoId) {
    if (!confirm('¬øEst√°s seguro de que deseas eliminar este proyecto h√≠brido?\n\nEsta acci√≥n eliminar√° todos los cap√≠tulos, subcap√≠tulos y partidas asociados.\n\nEsta acci√≥n no se puede deshacer.')) {
        return;
    }

    try {
        const response = await fetch(`http://localhost:3013/hybrid-proyectos/${proyectoId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            alert('‚úì Proyecto h√≠brido eliminado correctamente');
            location.reload();
        } else {
            throw new Error(data.detail || 'Error desconocido');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al eliminar proyecto h√≠brido:\n' + error.message);
    }
}
</script>
{% endblock %}
