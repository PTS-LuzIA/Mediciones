{% extends "base.html" %}

{% block title %}Proyectos IA - MVP Mediciones{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>ü§ñ Proyectos Procesados con IA</h2>
        <a href="/ai-upload" class="btn btn-success">+ Subir Nuevo PDF con IA</a>
    </div>

    {% if proyectos %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre</th>
                <th>Modelo</th>
                <th>Confianza</th>
                <th>Cap√≠tulos</th>
                <th>Partidas</th>
                <th>Fecha</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for proyecto in proyectos %}
            <tr>
                <td><span class="badge badge-info">#{{ proyecto.id }}</span></td>
                <td>
                    <a href="/ai-proyecto/{{ proyecto.id }}" style="color: #667eea; text-decoration: none; font-weight: 600;">
                        {{ proyecto.nombre or 'Sin nombre' }}
                    </a>
                </td>
                <td style="font-size: 0.85em; color: #6c757d;">{{ proyecto.modelo_usado }}</td>
                <td>
                    {% if proyecto.confianza_general %}
                    <span class="badge {% if proyecto.confianza_general >= 0.9 %}badge-success{% else %}badge-info{% endif %}">
                        {{ (proyecto.confianza_general * 100) | round(1) }}%
                    </span>
                    {% else %}
                    <span style="color: #6c757d;">-</span>
                    {% endif %}
                </td>
                <td>{{ proyecto.num_capitulos }}</td>
                <td><strong>{{ proyecto.num_partidas }}</strong></td>
                <td>{{ proyecto.fecha_creacion[:10] if proyecto.fecha_creacion else '-' }}</td>
                <td>
                    <div style="display: flex; gap: 8px;">
                        <a href="/ai-proyecto/{{ proyecto.id }}" class="btn" style="padding: 6px 12px; font-size: 0.9em;">
                            Ver Detalle
                        </a>
                        <button onclick="eliminarProyectoIA({{ proyecto.id }})"
                                class="btn"
                                style="padding: 6px 12px; font-size: 0.9em; background: #dc3545; color: white;"
                                title="Eliminar proyecto">
                            üóëÔ∏è
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
        <h3 style="margin-bottom: 20px;">No hay proyectos procesados con IA</h3>
        <p style="margin-bottom: 30px;">Sube tu primer PDF para procesarlo con Gemini AI</p>
        <a href="/ai-upload" class="btn btn-success">Subir PDF</a>
    </div>
    {% endif %}
</div>

{% if proyectos %}
<div class="card">
    <h3>Estad√≠sticas Generales - IA</h3>
    <div class="stats">
        <div class="stat-card">
            <h3>{{ proyectos|length }}</h3>
            <p>Proyectos Totales</p>
        </div>
        <div class="stat-card">
            <h3>{{ proyectos|sum(attribute='num_capitulos') }}</h3>
            <p>Cap√≠tulos</p>
        </div>
        <div class="stat-card">
            <h3>{{ proyectos|sum(attribute='num_partidas') }}</h3>
            <p>Partidas</p>
        </div>
        <div class="stat-card">
            {% set proyectos_con_confianza = proyectos|selectattr('confianza_general', 'ne', None)|list %}
            {% if proyectos_con_confianza %}
            <h3>{{ ((proyectos_con_confianza|sum(attribute='confianza_general') / proyectos_con_confianza|length) * 100) | round(1) }}%</h3>
            {% else %}
            <h3>-</h3>
            {% endif %}
            <p>Confianza Promedio</p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
async function eliminarProyectoIA(proyectoId) {
    if (!confirm('¬øEst√°s seguro de que deseas eliminar este proyecto IA?\n\nEsta acci√≥n eliminar√° todos los cap√≠tulos, subcap√≠tulos y partidas asociados.\n\nEsta acci√≥n no se puede deshacer.')) {
        return;
    }

    try {
        const response = await fetch(`http://localhost:3013/ai-proyectos/${proyectoId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            alert('‚úì Proyecto IA eliminado correctamente');
            location.reload();
        } else {
            throw new Error(data.detail || 'Error desconocido');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al eliminar proyecto IA:\n' + error.message);
    }
}
</script>
{% endblock %}
