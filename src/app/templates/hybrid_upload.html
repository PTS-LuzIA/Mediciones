{% extends "base.html" %}

{% block title %}Subir PDF - Sistema H√≠brido - MVP Mediciones{% endblock %}

{% block content %}
<div class="card">
    <h2>‚ö° Sistema H√≠brido (IA + Local + Validaci√≥n)</h2>
    <p style="margin: 20px 0; color: #6c757d;">
        Sube un PDF de presupuesto para procesarlo con el sistema h√≠brido de 3 fases
    </p>

    <div class="alert alert-info">
        <strong>üì§ Paso 1: Subir Archivo</strong>
        <p style="margin: 10px 0 0 0;">
            Sube tu PDF de presupuesto. El archivo se guardar√° y podr√°s elegir qu√© fases procesar desde la p√°gina del proyecto.
        </p>
    </div>

    <div class="alert alert-success">
        <strong>‚ú® Las 3 Fases del Sistema H√≠brido:</strong>
        <ul style="margin: 10px 0 0 20px;">
            <li><strong>Fase 1 - Estructura con IA:</strong> Extrae cap√≠tulos, subcap√≠tulos y totales</li>
            <li><strong>Fase 2 - Partidas con Parser Local:</strong> Extrae partidas individuales</li>
            <li><strong>Fase 3 - Validaci√≥n Cruzada:</strong> Compara totales IA vs Local</li>
        </ul>
        <p style="margin: 10px 0 0 0; font-weight: 600; color: #155724;">
            üí° Despu√©s de subir el archivo, podr√°s ejecutar cada fase individualmente
        </p>
    </div>

    <form id="uploadForm" enctype="multipart/form-data">
        <div class="upload-zone" id="uploadZone">
            <input type="file" id="fileInput" name="file" accept=".pdf" style="display: none;">
            <div id="uploadContent">
                <h3 style="color: #667eea; margin-bottom: 10px;">üìÑ Seleccionar PDF</h3>
                <p style="color: #6c757d;">Formatos soportados: PDF con presupuestos de construcci√≥n</p>
                <p style="color: #6c757d; font-size: 0.9em; margin-top: 10px;">
                    Click aqu√≠ o arrastra el archivo
                </p>
            </div>
            <div id="fileInfo" style="display: none;">
                <h3 style="color: #28a745; margin-bottom: 10px;">‚úì Archivo seleccionado</h3>
                <p id="fileName" style="color: #333; font-weight: 600;"></p>
                <p id="fileSize" style="color: #6c757d; font-size: 0.9em;"></p>

                <button type="submit" class="btn btn-success" style="margin-top: 20px;">
                    üì§ Subir PDF (Elegir Fases Despu√©s)
                </button>
            </div>
        </div>
    </form>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p><strong>Subiendo archivo PDF...</strong></p>
        <p style="color: #6c757d; font-size: 0.9em; margin-top: 10px;">
            Guardando el archivo en el servidor...
        </p>
        <p style="color: #6c757d; font-size: 0.85em; margin-top: 15px;">
            ‚ú® Una vez subido, podr√°s elegir qu√© fases procesar
        </p>
    </div>
</div>

<div class="card">
    <h3>üéØ Ventajas del Sistema H√≠brido</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
        <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px;">
            <h4 style="margin: 0 0 10px 0;">ü§ñ IA para Estructura</h4>
            <p style="margin: 0; opacity: 0.9; font-size: 0.9em;">
                Extracci√≥n inteligente de cap√≠tulos y subcap√≠tulos con totales
            </p>
        </div>
        <div style="padding: 20px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border-radius: 10px;">
            <h4 style="margin: 0 0 10px 0;">‚öôÔ∏è Parser para Partidas</h4>
            <p style="margin: 0; opacity: 0.9; font-size: 0.9em;">
                Extracci√≥n precisa y r√°pida de partidas individuales
            </p>
        </div>
        <div style="padding: 20px; background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; border-radius: 10px;">
            <h4 style="margin: 0 0 10px 0;">‚úì Validaci√≥n Cruzada</h4>
            <p style="margin: 0; opacity: 0.9; font-size: 0.9em;">
                Detecci√≥n autom√°tica de discrepancias entre IA y Local
            </p>
        </div>
    </div>
</div>

<div class="card">
    <h3>üìä Estados de Validaci√≥n</h3>
    <table style="margin-top: 15px;">
        <tr>
            <td style="padding: 10px; width: 200px;">
                <span class="badge badge-success" style="font-size: 1em;">‚úì VALIDADO</span>
            </td>
            <td style="padding: 10px;">
                Los totales de IA y Local coinciden (diferencia ‚â§ 5%)
            </td>
        </tr>
        <tr>
            <td style="padding: 10px;">
                <span class="badge" style="background: #ffc107; color: #000; font-size: 1em;">‚ö†Ô∏è DISCREPANCIA</span>
            </td>
            <td style="padding: 10px;">
                Los totales difieren m√°s del 5%. Requiere revisi√≥n
            </td>
        </tr>
        <tr>
            <td style="padding: 10px;">
                <span class="badge badge-info" style="font-size: 1em;">üìã REVISADO IA</span>
            </td>
            <td style="padding: 10px;">
                Discrepancia revisada y corregida por la IA
            </td>
        </tr>
        <tr>
            <td style="padding: 10px;">
                <span class="badge" style="background: #dc3545; color: white; font-size: 1em;">‚ùå ERROR</span>
            </td>
            <td style="padding: 10px;">
                Error durante el procesamiento
            </td>
        </tr>
    </table>
</div>

<div class="card">
    <h3>‚ÑπÔ∏è Informaci√≥n T√©cnica</h3>
    <table style="margin-top: 15px;">
        <tr>
            <td style="padding: 10px;"><strong>Fase 1 - IA:</strong></td>
            <td style="padding: 10px;">StructureExtractionAgent (Grok 4.1 Fast v√≠a OpenRouter)</td>
        </tr>
        <tr>
            <td style="padding: 10px;"><strong>Fase 2 - Local:</strong></td>
            <td style="padding: 10px;">PartidaParser (Parser tradicional basado en reglas)</td>
        </tr>
        <tr>
            <td style="padding: 10px;"><strong>Fase 3 - Validaci√≥n:</strong></td>
            <td style="padding: 10px;">Comparaci√≥n de totales en ‚Ç¨ con igualdad exacta (solo valor total, no conteo)</td>
        </tr>
        <tr>
            <td style="padding: 10px;"><strong>Base de datos:</strong></td>
            <td style="padding: 10px;">SQLite con modelos h√≠bridos (EstadoValidacion, FaseProyecto)</td>
        </tr>
        <tr>
            <td style="padding: 10px;"><strong>Tiempo estimado:</strong></td>
            <td style="padding: 10px;">1-3 minutos (seg√∫n tama√±o del PDF)</td>
        </tr>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
    const uploadZone = document.getElementById('uploadZone');
    const fileInput = document.getElementById('fileInput');
    const uploadContent = document.getElementById('uploadContent');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadForm = document.getElementById('uploadForm');
    const loading = document.getElementById('loading');

    // Click para abrir selector
    uploadZone.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') {
            fileInput.click();
        }
    });

    // Drag & Drop
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');

        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === 'application/pdf') {
            fileInput.files = files;
            showFileInfo(files[0]);
        }
    });

    // Cuando se selecciona archivo
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            showFileInfo(e.target.files[0]);
        }
    });

    function showFileInfo(file) {
        fileName.textContent = file.name;
        fileSize.textContent = formatBytes(file.size);
        uploadContent.style.display = 'none';
        fileInfo.style.display = 'block';
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Submit form
    uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        if (fileInput.files.length === 0) {
            alert('Por favor, selecciona un archivo PDF');
            return;
        }

        // Mostrar loading
        uploadZone.style.display = 'none';
        loading.classList.add('active');

        try {
            // Submit
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            const response = await fetch('/hybrid-upload', {
                method: 'POST',
                body: formData
            });

            if (response.redirected) {
                window.location.href = response.url;
            } else if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'Error al procesar PDF');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error: ' + error.message);
            loading.classList.remove('active');
            uploadZone.style.display = 'block';
        }
    });
</script>
{% endblock %}
