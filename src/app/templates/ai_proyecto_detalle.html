{% extends "base.html" %}

{% block title %}{{ proyecto.nombre }} - Proyecto IA{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2>ü§ñ {{ proyecto.nombre or 'Sin nombre' }}</h2>
            <p style="color: #6c757d; margin-top: 10px;">
                {% if proyecto.descripcion %}{{ proyecto.descripcion }}{% else %}Proyecto IA #{{ proyecto.id }}{% endif %}
            </p>
            {% if proyecto.confianza_general %}
            <div style="margin-top: 10px;">
                <span class="badge {% if proyecto.confianza_general >= 0.9 %}badge-success{% else %}badge-info{% endif %}" style="font-size: 1em;">
                    Confianza General: {{ (proyecto.confianza_general * 100) | round(1) }}%
                </span>
            </div>
            {% endif %}
        </div>
        <div>
            <a href="/ai-proyectos" class="btn btn-secondary">‚Üê Volver</a>
        </div>
    </div>

    {% if proyecto.notas_ia %}
    <div class="alert alert-success" style="margin-top: 20px;">
        <strong>üìù Notas de la IA:</strong>
        <p style="margin: 10px 0 0 0;">{{ proyecto.notas_ia }}</p>
    </div>
    {% endif %}
</div>

<div class="card">
    <h3>Resumen de Presupuesto por Cap√≠tulos</h3>

    <table style="margin-top: 20px;">
        <thead>
            <tr>
                <th>C√≥digo</th>
                <th>Cap√≠tulo</th>
                <th style="text-align: center;">Partidas</th>
                <th style="text-align: center;">Confianza</th>
                <th style="text-align: right;">Importe Total</th>
            </tr>
        </thead>
        <tbody>
            {% set ns = namespace(total_general=0, total_partidas=0, suma_confianza=0, items_confianza=0) %}
            {% for capitulo in proyecto.capitulos %}
                {% set ns_cap = namespace(total_capitulo=0, num_partidas_cap=0) %}

                {# Calcular total del cap√≠tulo sumando todas sus partidas #}
                {% for partida in capitulo.partidas %}
                    {% set ns_cap.total_capitulo = ns_cap.total_capitulo + partida.importe %}
                    {% set ns_cap.num_partidas_cap = ns_cap.num_partidas_cap + 1 %}
                {% endfor %}

                {% for subcapitulo in capitulo.subcapitulos %}
                    {% for partida in subcapitulo.partidas %}
                        {% set ns_cap.total_capitulo = ns_cap.total_capitulo + partida.importe %}
                        {% set ns_cap.num_partidas_cap = ns_cap.num_partidas_cap + 1 %}
                    {% endfor %}
                    {% for apartado in subcapitulo.apartados %}
                        {% for partida in apartado.partidas %}
                            {% set ns_cap.total_capitulo = ns_cap.total_capitulo + partida.importe %}
                            {% set ns_cap.num_partidas_cap = ns_cap.num_partidas_cap + 1 %}
                        {% endfor %}
                    {% endfor %}
                {% endfor %}

                {% set ns.total_general = ns.total_general + ns_cap.total_capitulo %}
                {% set ns.total_partidas = ns.total_partidas + ns_cap.num_partidas_cap %}
                {% if capitulo.confianza %}
                    {% set ns.suma_confianza = ns.suma_confianza + capitulo.confianza %}
                    {% set ns.items_confianza = ns.items_confianza + 1 %}
                {% endif %}

                <tr>
                    <td><strong>{{ capitulo.codigo }}</strong></td>
                    <td>{{ capitulo.nombre }}</td>
                    <td style="text-align: center;">{{ ns_cap.num_partidas_cap }}</td>
                    <td style="text-align: center;">
                        {% if capitulo.confianza %}
                        <span class="badge {% if capitulo.confianza >= 0.9 %}badge-success{% else %}badge-info{% endif %}">
                            {{ (capitulo.confianza * 100) | round(0) }}%
                        </span>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td style="text-align: right; font-weight: 600;">{{ ns_cap.total_capitulo|european }} ‚Ç¨</td>
                </tr>
            {% endfor %}
        </tbody>
        <tfoot style="border-top: 2px solid #667eea;">
            <tr style="background: #f8f9ff; font-weight: bold; font-size: 1.1em;">
                <td colspan="2"><strong>TOTAL PRESUPUESTO</strong></td>
                <td style="text-align: center; color: #667eea;">{{ ns.total_partidas }}</td>
                <td style="text-align: center;">
                    {% if ns.items_confianza > 0 %}
                    <span class="badge badge-success">{{ ((ns.suma_confianza / ns.items_confianza) * 100) | round(0) }}%</span>
                    {% endif %}
                </td>
                <td style="text-align: right; color: #667eea;">{{ ns.total_general|european }} ‚Ç¨</td>
            </tr>
        </tfoot>
    </table>

    <div style="margin-top: 20px; padding: 15px; background: #f8f9ff; border-left: 4px solid #667eea; border-radius: 5px;">
        <p style="margin: 0; color: #495057;">
            <strong>Verificaci√≥n:</strong>
            Este presupuesto contiene <strong>{{ ns.total_partidas }} partidas</strong>
            distribuidas en <strong>{{ proyecto.capitulos|length }} cap√≠tulos</strong>,
            con un importe total de <strong style="color: #667eea;">{{ ns.total_general|european }} ‚Ç¨</strong>
        </p>
    </div>
</div>

<div class="card">
    <h3>Exportar Presupuesto</h3>
    <p style="color: #6c757d; margin: 15px 0;">
        Descarga el presupuesto en diferentes formatos:
    </p>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <a href="http://localhost:3013/ai-exportar/{{ proyecto.id }}/csv"
           class="btn"
           download>
            üìÑ Exportar CSV
        </a>
        <a href="http://localhost:3013/ai-exportar/{{ proyecto.id }}/excel"
           class="btn"
           download>
            üìä Exportar Excel
        </a>
        <a href="http://localhost:3013/ai-exportar/{{ proyecto.id }}/xml"
           class="btn"
           download>
            üìã Exportar XML
        </a>
        <a href="http://localhost:3013/ai-exportar/{{ proyecto.id }}/bc3"
           class="btn"
           download>
            üèóÔ∏è Exportar BC3/FIEBDC-3
        </a>
    </div>
</div>

<!-- PESTA√ëA IA: PROCESAMIENTO POR FASES -->
<div class="card">
    <h3>ü§ñ Procesamiento con IA</h3>
    <p style="color: #6c757d; margin-bottom: 20px;">Extracci√≥n inteligente en dos fases: primero la estructura, luego las partidas</p>

    <!-- FASE 1: ESTRUCTURA -->
    <div style="border: 2px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 20px; background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="margin: 0; color: #667eea;">
                üìã FASE 1: Estructura del Presupuesto
            </h4>
            <div id="fase1-status">
                {% if proyecto.capitulos %}
                <span class="badge badge-success" style="font-size: 1em;">‚úì Completada</span>
                {% else %}
                <span class="badge" style="background: #ffc107; color: #000; font-size: 1em;">‚è≥ Pendiente</span>
                {% endif %}
            </div>
        </div>

        <p style="color: #6c757d; margin-bottom: 15px;">
            Extrae √∫nicamente los cap√≠tulos, subcap√≠tulos y sus totales. Esto permite validar la estructura antes de procesar las partidas.
        </p>
        <div style="padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; margin-bottom: 15px; border-radius: 3px;">
            <small style="color: #856404;">
                <strong>‚ö†Ô∏è Nota:</strong> Los totales mostrados son extra√≠dos directamente del PDF por la IA.
                Estos valores se recalcular√°n autom√°ticamente cuando se extraigan las partidas en la Fase 2.
            </small>
        </div>

        {% if not proyecto.capitulos %}
        <!-- Bot√≥n para iniciar extracci√≥n de estructura -->
        <button id="btn-extract-structure"
                onclick="extractStructure({{ proyecto.id }})"
                class="btn"
                style="background: #667eea; color: white;">
            üîç Extraer Estructura
        </button>
        <div id="structure-loading" style="display: none; margin-top: 15px;">
            <div style="padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 5px;">
                <strong>‚è≥ Procesando...</strong>
                <p style="margin: 10px 0 0 0;">Extrayendo la estructura jer√°rquica del presupuesto. Esto puede tardar unos segundos.</p>
            </div>
        </div>
        {% else %}
        <!-- Estructura extra√≠da -->
        <div id="structure-tree" style="margin-top: 15px;">
            <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #28a745;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong style="color: #28a745;">‚úì Estructura extra√≠da correctamente</strong>
                    <button id="btn-reextract-structure"
                            onclick="reExtractStructure({{ proyecto.id }})"
                            class="btn"
                            style="background: #ffc107; color: #000; font-size: 0.85em; padding: 8px 15px;">
                        üîÑ Re-extraer
                    </button>
                </div>
                <div style="margin-top: 10px;">
                    {% for capitulo in proyecto.capitulos %}
                    <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 3px; border-left: 3px solid #667eea;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="color: #667eea;">üìÅ {{ capitulo.codigo }} - {{ capitulo.nombre }}</strong>
                                {% if capitulo.subcapitulos %}
                                <span style="color: #6c757d; font-size: 0.9em; margin-left: 10px;">
                                    ({{ capitulo.subcapitulos|length }} subcap√≠tulos)
                                </span>
                                {% endif %}
                            </div>
                            <strong style="color: #667eea;">{{ capitulo.total|european }} ‚Ç¨</strong>
                        </div>
                        {% if capitulo.subcapitulos %}
                        <div style="margin-left: 20px; margin-top: 10px;">
                            {# Macro recursivo para mostrar subcap√≠tulos anidados #}
                            {% macro mostrar_subcapitulos(subcaps, nivel=1) %}
                                {% for subcapitulo in subcaps %}
                                <div style="padding: 5px 0; color: #6c757d; font-size: 0.9em; margin-left: {{ (nivel - 1) * 15 }}px;">
                                    ‚îî‚îÄ {{ subcapitulo.codigo }} - {{ subcapitulo.nombre }}
                                    <span style="float: right; color: #764ba2; font-weight: 600;">{{ subcapitulo.total|european }} ‚Ç¨</span>
                                </div>
                                {# Recursi√≥n: mostrar subcap√≠tulos hijos #}
                                {% if subcapitulo.subcapitulos %}
                                    {{ mostrar_subcapitulos(subcapitulo.subcapitulos, nivel + 1) }}
                                {% endif %}
                                {% endfor %}
                            {% endmacro %}

                            {{ mostrar_subcapitulos(capitulo.subcapitulos, 1) }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>

            <button onclick="toggleStructureDetail()"
                    class="btn"
                    style="margin-top: 15px; background: #6c757d; color: white;">
                Ver estructura completa ‚Üì
            </button>
        </div>
        {% endif %}
    </div>

    <!-- FASE 2: EXTRACCI√ìN DE PARTIDAS -->
    <div style="border: 2px solid {% if proyecto.capitulos %}#667eea{% else %}#dee2e6{% endif %}; border-radius: 10px; padding: 20px; background: {% if proyecto.capitulos %}linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%){% else %}#f8f9fa{% endif %};">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="margin: 0; color: {% if proyecto.capitulos %}#667eea{% else %}#6c757d{% endif %};">
                üìä FASE 2: Extracci√≥n de Partidas
            </h4>
            <div id="fase2-status">
                {% set tiene_partidas = False %}
                {% for capitulo in proyecto.capitulos %}
                    {% for subcapitulo in capitulo.subcapitulos %}
                        {% if subcapitulo.partidas %}
                            {% set tiene_partidas = True %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}

                {% if tiene_partidas %}
                <span class="badge badge-success" style="font-size: 1em;">‚úì Completada</span>
                {% elif proyecto.capitulos %}
                <span class="badge" style="background: #ffc107; color: #000; font-size: 1em;">‚è≥ Pendiente</span>
                {% else %}
                <span class="badge" style="background: #dee2e6; color: #6c757d; font-size: 1em;">üîí Bloqueada</span>
                {% endif %}
            </div>
        </div>

        <p style="color: {% if proyecto.capitulos %}#6c757d{% else %}#adb5bd{% endif %}; margin-bottom: 15px;">
            Una vez validada la estructura, extrae todas las partidas individuales con sus mediciones, precios e importes.
        </p>

        {% if not proyecto.capitulos %}
        <div style="padding: 15px; background: #f8f9fa; border-left: 4px solid #dee2e6; border-radius: 5px;">
            <strong style="color: #6c757d;">üîí Fase bloqueada</strong>
            <p style="margin: 10px 0 0 0; color: #6c757d;">
                Complete primero la Fase 1 (Extracci√≥n de Estructura) para desbloquear la extracci√≥n de partidas.
            </p>
        </div>
        {% elif not tiene_partidas %}
        <button id="btn-extract-partidas"
                onclick="extractPartidas({{ proyecto.id }})"
                class="btn"
                style="background: #667eea; color: white;">
            üöÄ Extraer Partidas
        </button>
        <div id="partidas-loading" style="display: none; margin-top: 15px;">
            <div style="padding: 15px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 5px;">
                <strong>‚è≥ Procesando...</strong>
                <p style="margin: 10px 0 0 0;">Extrayendo todas las partidas del presupuesto. Este proceso puede tardar varios minutos dependiendo del tama√±o del documento.</p>
            </div>
        </div>
        {% else %}
        <div style="background: #d4edda; padding: 15px; border-left: 4px solid #28a745; border-radius: 5px;">
            <strong style="color: #155724;">‚úì Partidas extra√≠das correctamente</strong>
            <p style="margin: 10px 0 0 0; color: #155724;">
                Se han procesado todas las partidas del presupuesto. Ver desglose completo abajo.
            </p>
        </div>
        {% endif %}
    </div>
</div>

{% if proyecto.capitulos %}
<div class="card">
    <h3>Estructura del Presupuesto</h3>
    <p style="color: #6c757d; margin-bottom: 20px;">Click en cada subcap√≠tulo para ver el desglose de partidas</p>

    {# Macro recursivo para renderizar subcap√≠tulos anidados #}
    {% macro renderizar_subcapitulos(subcapitulos, prefijo_id, margen_izq=0) %}
        {% for subcapitulo in subcapitulos %}
        {% set ns_sub = namespace(total_sub=0, num_partidas=0) %}

        {# Calcular total del subcap√≠tulo (partidas directas + apartados) #}
        {% for partida in subcapitulo.partidas %}
            {% set ns_sub.total_sub = ns_sub.total_sub + partida.importe %}
            {% set ns_sub.num_partidas = ns_sub.num_partidas + 1 %}
        {% endfor %}
        {% for apartado in subcapitulo.apartados %}
            {% for partida in apartado.partidas %}
                {% set ns_sub.total_sub = ns_sub.total_sub + partida.importe %}
                {% set ns_sub.num_partidas = ns_sub.num_partidas + 1 %}
            {% endfor %}
        {% endfor %}

        <div style="margin: 15px 0; margin-left: {{ margen_izq }}px;">
            {# Cabecera colapsable del subcap√≠tulo #}
            <div onclick="toggleSubcapitulo('{{ prefijo_id }}_{{ loop.index }}')"
                 style="cursor: pointer; padding: 15px; background: #f8f9fa; border-radius: 5px; border-left: 3px solid #764ba2; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s;"
                 onmouseover="this.style.background='#e9ecef'"
                 onmouseout="this.style.background='#f8f9fa'">
                <div>
                    <strong style="color: #764ba2; font-size: 1.05em;">‚ñ∂ {{ subcapitulo.codigo }} - {{ subcapitulo.nombre }}</strong>
                    <span style="color: #6c757d; font-size: 0.9em; margin-left: 15px;">
                        ({{ ns_sub.num_partidas }} partidas{% if subcapitulo.subcapitulos %}, {{ subcapitulo.subcapitulos|length }} subcap√≠tulos{% endif %})
                    </span>
                    {% if subcapitulo.confianza %}
                    <span class="badge {% if subcapitulo.confianza >= 0.9 %}badge-success{% else %}badge-info{% endif %}" style="margin-left: 10px;">
                        {{ (subcapitulo.confianza * 100) | round(0) }}%
                    </span>
                    {% endif %}
                </div>
                <strong style="color: #764ba2; font-size: 1.1em;">
                    {{ ns_sub.total_sub|european }} ‚Ç¨
                </strong>
            </div>

            {# Contenido colapsable #}
            <div id="{{ prefijo_id }}_{{ loop.index }}" style="display: none; margin-top: 10px; padding: 15px; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 5px;">
                {% if subcapitulo.notas %}
                <div style="padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; margin-bottom: 15px; border-radius: 3px;">
                    <small style="color: #856404;"><strong>‚ö†Ô∏è Nota:</strong> {{ subcapitulo.notas }}</small>
                </div>
                {% endif %}

                {# PARTIDAS DIRECTAS DEL SUBCAP√çTULO #}
                {% if subcapitulo.partidas %}
                <table style="width: 100%; font-size: 0.9em;">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Resumen</th>
                            <th>Unidad</th>
                            <th style="text-align: right;">Cantidad</th>
                            <th style="text-align: right;">Precio</th>
                            <th style="text-align: right;">Importe</th>
                            <th style="text-align: center;">Conf.</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for partida in subcapitulo.partidas %}
                        <tr {% if partida.notas %}style="background: #fffbf0;"{% endif %}>
                            <td><code>{{ partida.codigo }}</code></td>
                            <td>
                                {{ partida.resumen[:50] }}{% if partida.resumen|length > 50 %}...{% endif %}
                                {% if partida.notas %}
                                <br><small style="color: #856404;">‚ö†Ô∏è {{ partida.notas }}</small>
                                {% endif %}
                            </td>
                            <td>{{ partida.unidad }}</td>
                            <td style="text-align: right;">{{ partida.cantidad|european }}</td>
                            <td style="text-align: right;">{{ partida.precio|european }} ‚Ç¨</td>
                            <td style="text-align: right;"><strong>{{ partida.importe|european }} ‚Ç¨</strong></td>
                            <td style="text-align: center;">
                                {% if partida.confianza %}
                                <span class="badge {% if partida.confianza >= 0.9 %}badge-success{% else %}badge-info{% endif %}" style="font-size: 0.75em;">
                                    {{ (partida.confianza * 100) | round(0) }}%
                                </span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}

                {# APARTADOS DEL SUBCAP√çTULO #}
                {% for apartado in subcapitulo.apartados %}
                <div style="margin-top: 20px;">
                    <h6 style="color: #6c757d; margin-bottom: 10px; font-weight: 600;">
                        {{ apartado.codigo }} - {{ apartado.nombre }}
                        {% if apartado.confianza %}
                        <span class="badge {% if apartado.confianza >= 0.9 %}badge-success{% else %}badge-info{% endif %}">
                            {{ (apartado.confianza * 100) | round(0) }}%
                        </span>
                        {% endif %}
                    </h6>

                    {% if apartado.notas %}
                    <div style="padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; margin-bottom: 10px; border-radius: 3px;">
                        <small style="color: #856404;"><strong>‚ö†Ô∏è Nota:</strong> {{ apartado.notas }}</small>
                    </div>
                    {% endif %}

                    {% if apartado.partidas %}
                    <table style="width: 100%; font-size: 0.85em;">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Resumen</th>
                                <th>Unidad</th>
                                <th style="text-align: right;">Cantidad</th>
                                <th style="text-align: right;">Precio</th>
                                <th style="text-align: right;">Importe</th>
                                <th style="text-align: center;">Conf.</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for partida in apartado.partidas %}
                            <tr {% if partida.notas %}style="background: #fffbf0;"{% endif %}>
                                <td><code>{{ partida.codigo }}</code></td>
                                <td>
                                    {{ partida.resumen[:40] }}{% if partida.resumen|length > 40 %}...{% endif %}
                                    {% if partida.notas %}
                                    <br><small style="color: #856404;">‚ö†Ô∏è {{ partida.notas }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ partida.unidad }}</td>
                                <td style="text-align: right;">{{ partida.cantidad|european }}</td>
                                <td style="text-align: right;">{{ partida.precio|european }} ‚Ç¨</td>
                                <td style="text-align: right;"><strong>{{ partida.importe|european }} ‚Ç¨</strong></td>
                                <td style="text-align: center;">
                                    {% if partida.confianza %}
                                    <span class="badge {% if partida.confianza >= 0.9 %}badge-success{% else %}badge-info{% endif %}" style="font-size: 0.7em;">
                                        {{ (partida.confianza * 100) | round(0) }}%
                                    </span>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% endif %}
                </div>
                {% endfor %}

                {# RECURSI√ìN: Renderizar subcap√≠tulos hijos #}
                {% if subcapitulo.subcapitulos %}
                <div style="margin-top: 20px; padding-top: 15px; border-top: 2px dashed #dee2e6;">
                    <h6 style="color: #667eea; margin-bottom: 15px;">üìÇ Subcap√≠tulos de nivel inferior:</h6>
                    {{ renderizar_subcapitulos(subcapitulo.subcapitulos, prefijo_id ~ '_' ~ loop.index, 0) }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    {% endmacro %}

    {% for capitulo in proyecto.capitulos %}
    <div style="border-left: 4px solid #667eea; padding-left: 20px; margin: 30px 0;">
        <h4 style="color: #667eea; margin-bottom: 15px;">
            {{ capitulo.codigo }} - {{ capitulo.nombre }}
            {% if capitulo.confianza %}
            <span class="badge {% if capitulo.confianza >= 0.9 %}badge-success{% else %}badge-info{% endif %}" style="margin-left: 10px;">
                {{ (capitulo.confianza * 100) | round(0) }}%
            </span>
            {% endif %}
        </h4>

        {% if capitulo.notas %}
        <div style="padding: 10px; background: #fff3cd; border-left: 3px solid #ffc107; margin-bottom: 15px; border-radius: 3px;">
            <small style="color: #856404;"><strong>‚ö†Ô∏è Nota:</strong> {{ capitulo.notas }}</small>
        </div>
        {% endif %}

        {% if capitulo.subcapitulos %}
        {# Renderizar todos los subcap√≠tulos recursivamente #}
        {{ renderizar_subcapitulos(capitulo.subcapitulos, 'sub_' ~ capitulo.codigo, 0) }}
        {% endif %}

        {# Total del cap√≠tulo #}
        <div style="margin-top: 20px; padding: 15px; background: #f0f1ff; border-radius: 5px; border: 2px solid #667eea;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong style="color: #667eea; font-size: 1.2em;">TOTAL {{ capitulo.codigo }}</strong>
                <strong style="color: #667eea; font-size: 1.3em;">
                    {{ capitulo.total|european }} ‚Ç¨
                </strong>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="card">
    <h3>Informaci√≥n del Archivo</h3>
    <table style="width: auto;">
        <tr>
            <td style="font-weight: 600; width: 200px;">Archivo origen:</td>
            <td>{{ proyecto.archivo_origen }}</td>
        </tr>
        <tr>
            <td style="font-weight: 600;">Modelo usado:</td>
            <td><code>{{ proyecto.modelo_usado }}</code></td>
        </tr>
        <tr>
            <td style="font-weight: 600;">Fecha de procesamiento:</td>
            <td>{{ proyecto.fecha_creacion[:19] if proyecto.fecha_creacion else '-' }}</td>
        </tr>
        <tr>
            <td style="font-weight: 600;">Tiempo de procesamiento:</td>
            <td>{{ proyecto.tiempo_procesamiento|round(2) if proyecto.tiempo_procesamiento else '-' }} segundos</td>
        </tr>
        <tr>
            <td style="font-weight: 600;">ID del proyecto:</td>
            <td><span class="badge badge-info">#{{ proyecto.id }}</span></td>
        </tr>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleSubcapitulo(id) {
    const element = document.getElementById(id);
    const header = element.previousElementSibling;
    const arrow = header.querySelector('strong');

    if (element.style.display === 'none') {
        element.style.display = 'block';
        arrow.textContent = arrow.textContent.replace('‚ñ∂', '‚ñº');
    } else {
        element.style.display = 'none';
        arrow.textContent = arrow.textContent.replace('‚ñº', '‚ñ∂');
    }
}

function toggleStructureDetail() {
    // Navegar a la secci√≥n de estructura completa m√°s abajo
    const estructuraSection = document.querySelector('.card h3');
    if (estructuraSection && estructuraSection.textContent.includes('Estructura del Presupuesto')) {
        estructuraSection.scrollIntoView({ behavior: 'smooth' });
    }
}

// FASE 1: Extraer estructura
async function extractStructure(proyectoId) {
    const btn = document.getElementById('btn-extract-structure');
    const loading = document.getElementById('structure-loading');

    // Deshabilitar bot√≥n y mostrar loading
    btn.disabled = true;
    btn.style.opacity = '0.6';
    loading.style.display = 'block';

    try {
        const response = await fetch(`http://localhost:3013/api/extract-structure/${proyectoId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            // Mostrar mensaje de √©xito y recargar p√°gina
            alert('‚úì Estructura extra√≠da correctamente!\n\n' +
                  `Cap√≠tulos encontrados: ${data.estructura.capitulos.length}\n` +
                  `Tiempo: ${data.tiempo_procesamiento.toFixed(2)}s`);
            location.reload();
        } else {
            throw new Error(data.detail || 'Error desconocido');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al extraer estructura:\n' + error.message);
        btn.disabled = false;
        btn.style.opacity = '1';
        loading.style.display = 'none';
    }
}

// Re-extraer estructura (usa el mismo endpoint pero con confirmaci√≥n)
async function reExtractStructure(proyectoId) {
    if (!confirm('¬øRe-extraer la estructura?\n\nEsto eliminar√° la estructura actual y la volver√° a procesar con el agente mejorado.')) {
        return;
    }

    const btn = document.getElementById('btn-reextract-structure');
    const structureTree = document.getElementById('structure-tree');

    // Deshabilitar bot√≥n y mostrar loading
    btn.disabled = true;
    btn.style.opacity = '0.6';
    btn.textContent = '‚è≥ Procesando...';

    try {
        const response = await fetch(`http://localhost:3013/api/extract-structure/${proyectoId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            // Mostrar mensaje de √©xito y recargar p√°gina
            let mensaje = '‚úì Estructura re-extra√≠da correctamente!\n\n' +
                  `Cap√≠tulos encontrados: ${data.estructura.capitulos.length}\n` +
                  `Tiempo: ${data.tiempo_procesamiento.toFixed(2)}s`;

            if (data.validacion && !data.validacion.valido) {
                mensaje += '\n\n‚ö†Ô∏è Advertencia: Se encontraron inconsistencias en los totales.';
            }

            alert(mensaje);
            location.reload();
        } else {
            throw new Error(data.detail || 'Error desconocido');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al re-extraer estructura:\n' + error.message);
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.textContent = 'üîÑ Re-extraer';
    }
}

// FASE 2: Extraer partidas
async function extractPartidas(proyectoId) {
    const btn = document.getElementById('btn-extract-partidas');
    const loading = document.getElementById('partidas-loading');

    // Confirmar acci√≥n
    if (!confirm('¬øIniciar extracci√≥n de partidas?\n\nEste proceso procesar√° todos los cap√≠tulos y puede tardar varios minutos.\n\n¬øContinuar?')) {
        return;
    }

    // Deshabilitar bot√≥n y mostrar loading
    btn.disabled = true;
    btn.style.opacity = '0.6';
    loading.style.display = 'block';

    try {
        const response = await fetch(`http://localhost:3013/api/extract-partidas/${proyectoId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const estado = await response.json();

        if (estado.estado === 'completed') {
            // Extracci√≥n completada exitosamente
            let mensaje = '‚úì Extracci√≥n de partidas completada!\n\n' +
                  `Partidas extra√≠das: ${estado.resumen.total_partidas}\n` +
                  `Cap√≠tulos procesados: ${estado.resumen.capitulos_procesados}/${estado.resumen.capitulos_totales}`;

            alert(mensaje);
            location.reload();
        } else if (estado.estado === 'partial') {
            // Extracci√≥n parcial con algunos errores
            let mensaje = '‚ö†Ô∏è Extracci√≥n parcial completada\n\n' +
                  `Partidas extra√≠das: ${estado.resumen.total_partidas}\n` +
                  `Cap√≠tulos procesados: ${estado.resumen.capitulos_procesados}/${estado.resumen.capitulos_totales}\n` +
                  `Cap√≠tulos con error: ${estado.resumen.capitulos_error}\n\n` +
                  'Revisa los detalles para ver qu√© cap√≠tulos fallaron.';

            // Mostrar detalles de errores
            const capitulos_error = estado.capitulos.filter(c => c.estado === 'error');
            if (capitulos_error.length > 0) {
                mensaje += '\n\nCap√≠tulos con error:\n';
                capitulos_error.forEach(c => {
                    mensaje += `- ${c.codigo}: ${c.error}\n`;
                });
            }

            alert(mensaje);
            location.reload();
        } else {
            throw new Error(estado.error || 'Error desconocido en la extracci√≥n');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al extraer partidas:\n' + error.message);
        btn.disabled = false;
        btn.style.opacity = '1';
        loading.style.display = 'none';
    }
}
</script>
{% endblock %}
